<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Push Notification Test - iPhone Safari</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="/static/manifest.json">

    <!-- iOS Specific Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Push Test">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
        }

        h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 10px;
            text-align: center;
        }

        .subtitle {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-bottom: 30px;
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            text-align: center;
        }

        .status.info {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status.success {
            background: #e8f5e9;
            color: #388e3c;
        }

        .status.error {
            background: #ffebee;
            color: #d32f2f;
        }

        button {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        .divider {
            height: 1px;
            background: #e0e0e0;
            margin: 25px 0;
        }

        #notification-log {
            max-height: 200px;
            overflow-y: auto;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 10px;
            font-size: 12px;
            margin-top: 20px;
        }

        .log-entry {
            margin-bottom: 5px;
            color: #666;
        }

        .icon {
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîî Push Notification Test</h1>
        <p class="subtitle">iPhone Safari Ìë∏Ïãú ÏïåÎ¶º ÌÖåÏä§Ìä∏</p>

        <div id="status" class="status info">
            <span class="icon">‚ÑπÔ∏è</span>
            <span id="status-text">Ï¥àÍ∏∞Ìôî Ï§ë...</span>
        </div>

        <button id="subscribe-btn" class="btn-primary" disabled>
            ÏïåÎ¶º Íµ¨ÎèÖÌïòÍ∏∞
        </button>

        <button id="unsubscribe-btn" class="btn-danger" style="display: none;">
            ÏïåÎ¶º Íµ¨ÎèÖ Ìï¥Ï†ú
        </button>

        <div class="divider"></div>

        <div class="input-group">
            <label for="notification-title">ÏïåÎ¶º Ï†úÎ™©</label>
            <input type="text" id="notification-title" placeholder="ÌÖåÏä§Ìä∏ ÏïåÎ¶º" value="ÌÖåÏä§Ìä∏ ÏïåÎ¶º">
        </div>

        <div class="input-group">
            <label for="notification-body">ÏïåÎ¶º ÎÇ¥Ïö©</label>
            <input type="text" id="notification-body" placeholder="iPhoneÏóêÏÑú Ìë∏Ïãú ÏïåÎ¶º ÌÖåÏä§Ìä∏" value="iPhoneÏóêÏÑú Ìë∏Ïãú ÏïåÎ¶º ÌÖåÏä§Ìä∏">
        </div>

        <button id="send-btn" class="btn-success">
            Ìë∏Ïãú ÏïåÎ¶º Ï†ÑÏÜ°
        </button>

        <div id="notification-log">
            <div class="log-entry">üìã Î°úÍ∑∏:</div>
        </div>
    </div>

    <script>
        let swRegistration = null;
        let isSubscribed = false;

        const statusDiv = document.getElementById('status');
        const statusText = document.getElementById('status-text');
        const subscribeBtn = document.getElementById('subscribe-btn');
        const unsubscribeBtn = document.getElementById('unsubscribe-btn');
        const sendBtn = document.getElementById('send-btn');
        const logDiv = document.getElementById('notification-log');

        function addLog(message) {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(message, type = 'info') {
            statusText.textContent = message;
            statusDiv.className = `status ${type}`;
            addLog(message);
        }

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/\-/g, '+')
                .replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        async function initializeServiceWorker() {
            // Î∏åÎùºÏö∞Ï†Ä Ï†ïÎ≥¥ ÏàòÏßë
            const userAgent = navigator.userAgent;
            const isStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
            const displayMode = window.matchMedia('(display-mode: standalone)').matches ? 'standalone' :
                               window.matchMedia('(display-mode: fullscreen)').matches ? 'fullscreen' :
                               window.matchMedia('(display-mode: minimal-ui)').matches ? 'minimal-ui' : 'browser';

            addLog(`Î∏åÎùºÏö∞Ï†Ä: ${userAgent.includes('iPhone') ? 'iPhone Safari' : 'Unknown'}`);
            addLog(`iOS Î≤ÑÏ†Ñ: ${userAgent.match(/OS (\d+)_(\d+)/)?.[0] || 'Ïïå Ïàò ÏóÜÏùå'}`);
            addLog(`Display Mode: ${displayMode}`);
            addLog(`navigator.standalone: ${window.navigator.standalone || false}`);
            addLog(`ÎèÖÎ¶Ω Ïã§Ìñâ Î™®Îìú: ${isStandalone ? '‚úÖ Ïòà (Ìôà ÌôîÎ©¥ Ïï±)' : '‚ùå ÏïÑÎãàÏò§ (Safari Î∏åÎùºÏö∞Ï†Ä)'}`);
            addLog(`HTTPS: ${location.protocol === 'https:' ? '‚úÖ Ïòà' : '‚ùå ÏïÑÎãàÏò§'}`);

            // Service Worker ÏßÄÏõê ÌôïÏù∏
            if (!('serviceWorker' in navigator)) {
                updateStatus('‚ùå Service Worker ÎØ∏ÏßÄÏõê - iOS 11.3 Ïù¥ÏÉÅ ÌïÑÏöî', 'error');
                addLog('Ìï¥Í≤∞: iOS Î≤ÑÏ†ÑÏùÑ 11.3 Ïù¥ÏÉÅÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏ÌïòÏÑ∏Ïöî');
                return;
            }
            addLog('‚úÖ Service Worker ÏßÄÏõêÎê®');

            // Push API ÏßÄÏõê ÌôïÏù∏
            if (!('PushManager' in window)) {
                updateStatus('‚ùå Push API ÎØ∏ÏßÄÏõê', 'error');

                if (!isStandalone) {
                    addLog('');
                    addLog('üö® ÌòÑÏû¨ Safari Î∏åÎùºÏö∞Ï†ÄÎ°ú Ïã§Ìñâ Ï§ëÏûÖÎãàÎã§!');
                    addLog('');
                    addLog('‚úÖ Ìï¥Í≤∞ Î∞©Î≤ï:');
                    addLog('1Ô∏è‚É£ Safari ÌïòÎã® Í≥µÏú† Î≤ÑÌäº(‚Üë) ÌÉ≠');
                    addLog('2Ô∏è‚É£ "Ìôà ÌôîÎ©¥Ïóê Ï∂îÍ∞Ä" ÏÑ†ÌÉù');
                    addLog('3Ô∏è‚É£ "Ï∂îÍ∞Ä" ÌÉ≠');
                    addLog('4Ô∏è‚É£ Safari ÏôÑÏ†ÑÌûà Îã´Í∏∞');
                    addLog('5Ô∏è‚É£ Ìôà ÌôîÎ©¥Ïùò "Push Test" ÏïÑÏù¥ÏΩòÏúºÎ°ú Ïã§Ìñâ');
                    addLog('');
                    addLog('‚ö†Ô∏è Safari Î∏åÎùºÏö∞Ï†ÄÍ∞Ä ÏïÑÎãå Ìôà ÌôîÎ©¥ ÏïÑÏù¥ÏΩòÏúºÎ°ú Ïã§ÌñâÌï¥Ïïº Ìï©ÎãàÎã§!');
                } else {
                    addLog('iOS 16.4 Ïù¥ÏÉÅÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
                    addLog(`ÌòÑÏû¨ iOS Î≤ÑÏ†Ñ: ${userAgent.match(/OS (\d+)_(\d+)/)?.[0] || 'Ïïå Ïàò ÏóÜÏùå'}`);
                }
                return;
            }
            addLog('‚úÖ Push API ÏßÄÏõêÎê®');

            // HTTPS ÌôïÏù∏
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                updateStatus('‚ùå HTTPS ÌïÑÏöî - Î°úÏª¨ ÎÑ§Ìä∏ÏõåÌÅ¨ÏóêÏÑúÎèÑ HTTPS ÌïÑÏàò', 'error');
                addLog('Ìï¥Í≤∞: ÏÑúÎ≤ÑÎ•º HTTPSÎ°ú Ïã§ÌñâÌïòÏÑ∏Ïöî');
                return;
            }
            addLog('‚úÖ HTTPS Ïó∞Í≤∞');

            try {
                // Service Worker Îì±Î°ù ÏòµÏÖò Ï∂îÍ∞Ä
                swRegistration = await navigator.serviceWorker.register('/sw.js', {
                    scope: '/',
                    updateViaCache: 'none'
                });

                // Îì±Î°ù ÏôÑÎ£å ÎåÄÍ∏∞
                await swRegistration.update();
                addLog('‚úÖ Service Worker Îì±Î°ù ÏÑ±Í≥µ');
                addLog(`   Scope: ${swRegistration.scope}`);
                addLog(`   ÏÉÅÌÉú: ${swRegistration.active ? 'active' : swRegistration.installing ? 'installing' : 'waiting'}`);

                // Í∏∞Ï°¥ Íµ¨ÎèÖ ÌôïÏù∏
                const subscription = await swRegistration.pushManager.getSubscription();
                isSubscribed = !(subscription === null);

                if (isSubscribed) {
                    updateStatus('Ìë∏Ïãú ÏïåÎ¶ºÏù¥ Íµ¨ÎèÖÎêòÏñ¥ ÏûàÏäµÎãàÎã§.', 'success');
                    subscribeBtn.style.display = 'none';
                    unsubscribeBtn.style.display = 'block';
                } else {
                    updateStatus('Ìë∏Ïãú ÏïåÎ¶ºÏùÑ Íµ¨ÎèÖÌï¥Ï£ºÏÑ∏Ïöî.', 'info');
                    subscribeBtn.disabled = false;
                }
            } catch (error) {
                updateStatus('Service Worker Îì±Î°ù Ïã§Ìå®: ' + error, 'error');
            }
        }

        async function subscribeUser() {
            try {
                const response = await fetch('/vapid-public-key');
                const vapidPublicKey = (await response.json()).publicKey;
                const convertedVapidKey = urlBase64ToUint8Array(vapidPublicKey);

                const subscription = await swRegistration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: convertedVapidKey
                });

                // ÏÑúÎ≤ÑÏóê Íµ¨ÎèÖ Ï†ïÎ≥¥ Ï†ÑÏÜ°
                const serverResponse = await fetch('/subscribe', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(subscription)
                });

                if (serverResponse.ok) {
                    const result = await serverResponse.json();
                    isSubscribed = true;

                    if (result.updated) {
                        updateStatus('‚úÖ Ïù¥ÎØ∏ Íµ¨ÎèÖÎêòÏñ¥ ÏûàÏäµÎãàÎã§ (Ï§ëÎ≥µ Î∞©ÏßÄÎê®)', 'success');
                        addLog('üí° Í∞ôÏùÄ Í∏∞Í∏∞ÏóêÏÑúÎäî ÌïòÎÇòÏùò Íµ¨ÎèÖÎßå Ïú†ÏßÄÎê©ÎãàÎã§');
                    } else {
                        updateStatus('‚úÖ Ìë∏Ïãú ÏïåÎ¶º Íµ¨ÎèÖ ÏôÑÎ£å!', 'success');
                    }

                    subscribeBtn.style.display = 'none';
                    unsubscribeBtn.style.display = 'block';
                }
            } catch (error) {
                updateStatus('Íµ¨ÎèÖ Ïã§Ìå®: ' + error, 'error');
            }
        }

        async function unsubscribeUser() {
            try {
                const subscription = await swRegistration.pushManager.getSubscription();
                if (subscription) {
                    await subscription.unsubscribe();

                    await fetch('/unsubscribe', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(subscription)
                    });

                    isSubscribed = false;
                    updateStatus('Ìë∏Ïãú ÏïåÎ¶º Íµ¨ÎèÖ Ìï¥Ï†úÎê®', 'info');
                    subscribeBtn.style.display = 'block';
                    unsubscribeBtn.style.display = 'none';
                }
            } catch (error) {
                updateStatus('Íµ¨ÎèÖ Ìï¥Ï†ú Ïã§Ìå®: ' + error, 'error');
            }
        }

        async function sendNotification() {
            const title = document.getElementById('notification-title').value;
            const body = document.getElementById('notification-body').value;

            try {
                const response = await fetch('/send-notification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ title, body })
                });

                const result = await response.json();
                if (result.success) {
                    updateStatus('Ìë∏Ïãú ÏïåÎ¶º Ï†ÑÏÜ° ÏÑ±Í≥µ!', 'success');
                } else {
                    updateStatus(result.message, 'error');
                }
            } catch (error) {
                updateStatus('Ï†ÑÏÜ° Ïã§Ìå®: ' + error, 'error');
            }
        }

        // Event Listeners
        subscribeBtn.addEventListener('click', subscribeUser);
        unsubscribeBtn.addEventListener('click', unsubscribeUser);
        sendBtn.addEventListener('click', sendNotification);

        // ÌéòÏù¥ÏßÄ Î°úÎìúÏãú Ï¥àÍ∏∞Ìôî
        window.addEventListener('load', initializeServiceWorker);
    </script>
</body>
</html>
